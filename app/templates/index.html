<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>易聊</title>
    <link rel="stylesheet" href="/static/css/amazeui.min.css"/>
    <link rel="stylesheet" href="/static/css/index/main.css"/>
    <link rel="import" href="/static/view/face.html" id="face"/>
    <link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/webuploader/webuploader.css">

    <link rel="stylesheet" type="text/css" href="/static/imagePreview/css/pictureViewer.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/index/processBar.css"/>
    <style>
        .send_msg {
            width: 160px;
            height: 80px;
        }
    </style>
</head>
<body>
<div class="box">
    <div class="wechat">
        <input type="hidden" id="user_id" value={{data[0].user_id}} >
        <input type="hidden" id="user_no" value={{data[0].user_no}} >
        <div class="sidestrip">
            <div class="am-dropdown" data-am-dropdown>
                <!--头像插件-->
                <div class="own_head am-dropdown-toggle" style="background: url(/static/images/head/{{data[0].pic_name}})"></div>
                <div class="am-dropdown-content">
                    <div class="own_head_top">
                        <div class="own_head_top_text">
                            <p class="own_name">{{data[0].user_nick_name}}<img src="/static/images/icon/head.png" alt=""/></p>
                            <p class="own_numb">易号：{{data[0].user_no}}</p>
                        </div>
                        <img src="/static/images/own_head.jpg" alt=""/>
                    </div>
                    <div class="own_head_bottom">
                        <p><span>地区</span>xx</p>
                        <div class="own_head_bottom_img">
                            <a href=""><img src="/static/images/icon/head_1.png"/></a>
                            <a href=""><img src="/static/images/icon/head_2.png"/></a>
                        </div>
                    </div>
                </div>
            </div>
            <!--三图标-->
            <div class="sidestrip_icon">
                <a id="si_1" style="background: url(/static/images/icon/head_2_1.png) no-repeat;"></a>
                <a id="si_2"></a>
                <a id="si_3"></a>
            </div>

            <!--底部扩展键-->
            <div id="doc-dropdown-justify-js">
                <div class="am-dropdown" id="doc-dropdown-js" style="position: initial;">
                    <div class="sidestrip_bc am-dropdown-toggle"></div>
                    <ul class="am-dropdown-content" style="">
                        <li>
                            <a href="#"
                               data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">意见反馈</a>
                            <div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
                                <div class="am-modal-dialog">
                                    <div class="am-modal-hd">Modal 标题
                                        <a href="javascript: void(0)" class="am-close am-close-spin"
                                           data-am-modal-close>&times;</a>
                                    </div>
                                    <div class="am-modal-bd">
                                        Modal 内容。本 Modal 无法通过遮罩层关闭。
                                    </div>
                                </div>
                            </div>
                        </li>

                        <li><a href="#">备份与恢复</a></li>
                        <li><a href="#">设置</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!--聊天对象列表-->
        <div class="middle on">
            <div class="wx_search">
                <input type="text" placeholder="搜索"/>
                <button>+</button>
            </div>
            <div class="office_text">
                <ul class="user_list">
                    {% for i in data[1] %}
                    <li
                            {% if loop.first %}
                            class="user_active"
                            {% endif %}
                            id={{i.lid}}
                            title = {{i.user_nick_name}}{{i.group_name}}
                    >
                        <div class="user_head"><img src=/static/images/head/{{i.pic_name}}/></div>
                        <div class="user_text">
                            <p class="user_name">
                                {% if not i.user_nick_name %}
                                {{i.group_name}}
                                {% else %}
                                {{i.user_nick_name}}
                                {% endif %}
                            </p>
                            <p class="user_message">{{i.content}}</p>
                        </div>
                        <div class="user_time">{{i.update_time}}</div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!--好友列表-->
        <div class="middle">
            <div class="wx_search">
                <input type="text" placeholder="搜索"/>
                <button>+</button>
            </div>
            <div class="office_text">
                <ul class="friends_list">
                    <li>
                        <p>新的朋友</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/1.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">新的朋友</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>公众号</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/2.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">公众号</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>A</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/3.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">彭于晏丶plus</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/4.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">陈依依</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/5.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">毛毛</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>B</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/6.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">苏笑言</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/7.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">往事不再提</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>C</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/8.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">夏继涛</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/9.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">早安无恙</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/10.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">王鹏</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>D</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/11.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">涨了潮了</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/12.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">Ktz丶中融资</p>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!--程序列表-->
        <div class="middle">
            <div class="wx_search">
                <input type="text" placeholder="搜索收藏内容"/>
                <button>+</button>
            </div>
            <div class="office_text">
                <ul class="icon_list">
                    <li class="icon_active">
                        <div class="icon"><img src="/static/images/icon/icon.png" alt=""/></div>
                        <span>全部收藏</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon1.png" alt=""/></div>
                        <span>链接</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon2.png" alt=""/></div>
                        <span>相册</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon3.png" alt=""/></div>
                        <span>笔记</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon4.png" alt=""/></div>
                        <span>文件</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon5.png" alt=""/></div>
                        <span>音乐</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon6.png" alt=""/></div>
                        <span>标签</span>
                    </li>
                </ul>
            </div>
        </div>

        <!--聊天窗口-->
        <div class="talk_window">
            <div class="windows_top">
                <div class="windows_top_box">
                    <span class="user_title"></span>
                    <ul class="window_icon">
                        <li><a href=""><img src="/static/images/icon/icon7.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon8.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon9.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon10.png"/></a></li>
                    </ul>
                    <div class="extend" class="am-btn am-btn-success"
                         data-am-offcanvas="{target: '#doc-oc-demo3'}"></div>
                    <!-- 侧边栏内容 -->
                    <div id="doc-oc-demo3" class="am-offcanvas">
                        <div class="am-offcanvas-bar am-offcanvas-bar-flip">
                            <div class="am-offcanvas-content">
                                <p><a href="http://music.163.com/#/song?id=385554" target="_blank">网易音乐</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--聊天内容-->
            <div class="windows_body">
                <div class="office_text" style="height: 100%;">
                    <!-- 聊天记录 -->
                    <ul class="content" id="chatbox">

                    </ul>
                </div>
            </div>

            <div class="windows_input" id="talkbox">
                <div class="input_icon" style="position:relative">
                    <a id="face_icon" href="javascript:;"></a>
                    <a id="picker" href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <!-- 表情 -->
                    <script type="text/javascript">
                        document.write(face.import.body.innerHTML)
                    </script>
                </div>
                <div class="input_box">
                    <!--<textarea name="" rows="" cols="" id="input_box"></textarea>-->
                    <div class="message_frame" contentEditable='true'></div>
                    <button id="send">发送（S）</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="/static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="/static/js/amazeui.min.js"></script>
<script type="text/javascript" src="/static/js/zUI.js"></script>
<script type="text/javascript" src="/static/js/index/wechat.js"></script>
<script src="/static/js/layer/layer.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/webuploader/webuploader.min.js"></script>
<script src="/static/imagePreview/js/pictureViewer.js"></script>

<script type="text/javascript">
    var now_time = (new Date()).getTime();
    //三图标
    window.onload = function () {
         //用户id
        var user_id = $('#user_id').val();
        //用户易号
        var user_no = $('#user_no').val();
        var pic_name = "{{data[0].pic_name}}"
        //获取聊天记录
        $(document).on('click', '.user_list li', function () {
            lid = $(this).attr("id");
            user_title=$(this).attr('title');
            $(this).addClass('user_active');
            $(this).siblings().removeClass('user_active');
            $('#chatbox').html('');
            //获取聊天记录
            $.get('/get_chat_records?user_id=' + user_id + '&lid=' + lid, function (data) {
                $('.windows_top_box .user_title').html(user_title);
                console.log(data);
                $.each(data, function (k, v) {
                     if (v.send_user_id == user_id){
                         u = 'me'
                     }else{
                         u = 'other'
                     }
                    info = '<li class='+u+'><img src="/static/images/head/'+v.userinfo.pic_name+'" title="'+v.userinfo.user_nick_name+'"><span>'+v.content+'</span></li>'
                     $('#chatbox').append(info)


                })
            },'json')
        });


        var j = 0;
        var task_id = WebUploader.Base.guid(); // 产生文件唯一标识符task_id
        var uploader = WebUploader.create({
            swf: './static/webuploader/Uploader.swf',
            server: '/file/upload/' + now_time, // 上传分片地址
            pick: '#picker',
            auto: true,
            chunked: true,
            chunkSize: 20 * 1024 * 1024,
            chunkRetry: 3,
            threads: 1,
            duplicate: true,
            formData: { // 上传分片的http请求中一同携带的数据
                task_id: task_id,
            },
        });
        arr_images = ['png', 'jpg', 'jpeg', 'jpeg', 'gif'];
        file_exts = ['avi', 'css', 'docx', 'html', 'ini', 'mp3', 'pptx', 'rar', 'xls', 'xlxs', 'pdf', 'ppt', 'txt', 'zip'];//文件后缀
        file_ext = true;
        chat = $('#chatbox');

        function get_file_size(filesize) {
            if (filesize < 1024) {
                filesize = filesize + 'B';
            } else if (filesize < (1024 * 1024)) {
                filesize = (filesize / 1024).toFixed(2) + 'K';
            } else if (filesize < (1024 * 1024 * 1024)) {
                filesize = (filesize / 1024 / 1024).toFixed(2) + 'M';
            } else {
                filesize = (filesize / 1024 / 1024 / 1024).toFixed(2) + 'G';
            }
            return filesize;
        }

        uploader.on('fileQueued', function (file) {
            a = jQuery.inArray(file.ext, arr_images);
            if (a != -1) {	//如果是图片
                file_ext = false;
            } else {
                file_ext = true;
            }
            //如果上传的不是图片
            if (file_ext) {
                chat.append('<li class="me"><img src="' + '/static/images/own_head.jpg' + '"><i></i></li>');
                $("#chatbox li").last().children('i').load('/static/view/processBar.html', function () {
                    //获取文件名
                    file_name = file.name;
                    str_file_ext = file.ext;
                    is_in = jQuery.inArray(str_file_ext, file_exts);
                    if (is_in == -1) {
                        file_icon = 'c.png'
                    } else {
                        file_icon = str_file_ext + '.png'
                    }
                    $(' .left_text').last().children('k').html(file_name);
                    $('.file_frame .right_file').last().children('img').attr('src', '/static/images/file_icon/' + file_icon);
                    //filename = file.name;
                    $('#progress').show();
                    $('.progress-bar').css('width', '0%');
                    $('.progress-bar').text('0%');
                    $('.progress-bar').removeClass('progress-bar-danger progress-bar-success');
                    //$('.progress-bar').addClass('active progress-bar-striped');

                    //让滚动条到最底部
                    chat = $('#chatbox');
                    scrollTop = chat[0].scrollHeight;
                    chat.parent().scrollTop(scrollTop);
                });

            }
        });
        uploader.on('startUpload', function () { // 开始上传时，调用该方法

        });

        uploader.on('uploadProgress', function (file, percentage) { // 一个分片上传成功后，调用该方法
            $('.progress-bar').css('width', percentage * 100 - 1 + '%');
            //$('.progress-bar').text(Math.floor(percentage * 100 - 1) + '%');
        });

        uploader.on('uploadSuccess', function (file) { // 整个文件的所有分片都上传成功后，调用该方法

            var data = {'task_id': task_id, 'filename': file.name, 'now_time': now_time};
            $.get('/file/merge', data, function () {
                if (file_ext) {

                }
            }, 'json');
            if (file_ext) {
                $('.progress-bar').css('width', '100%');
                $('.progress-bar').text('100%');
                $('.progress-bar').addClass('progress-bar-success');
                $('.progress-bar').text('上传成功');
                //关闭进度条
                $('#progress').remove();
                //显示文件大小
                filesize = get_file_size(file.size);
                $(' .middle_text').last().html(filesize);
            } else {
                file_info = file.source.source;
                var reader = new FileReader();
                //将文件以Data URL形式读入页面
                reader.readAsDataURL(file_info);
                reader.onload = function (e) {
                    $('#chatbox').append(
                        '<li class="me"><img src="' +
                        '/static/images/head/{{data[0].pic_name}}">' +
                        '<img class="send_msg" src="' + this.result + '" />' + '</li>'
                    );
                    //让滚动条到最底部
                    chat = $('#chatbox');
                    scrollTop = chat[0].scrollHeight;
                    chat.parent().scrollTop(scrollTop);
                }
            }

        });

        uploader.on('uploadError', function (file) { // 上传过程中发生异常，调用该方法
            $('.progress-bar').css('width', '100%');
            $('.progress-bar').text('100%');
            $('.progress-bar').addClass('progress-bar-danger');
            $('.progress-bar').text('上传失败');
        });

        uploader.on('uploadComplete', function (file) { // 上传结束，无论文件最终是否上传成功，该方法都会被调用
            $('.progress-bar').removeClass('active progress-bar-striped');
        });
        $('#progress').hide();
        //发送消息
        $('#send').click(function () {
            msg = $(this).prev('div');
            if (msg.html() == '') {
                layer.msg('消息不能为空');
            } else {
                chat = $('#chatbox');
                talk = $('#talkbox');
                chat.append('<li class="me"><img src="' + '/static/images/head/{{data[0].pic_name}}' +'"><span>' + msg.html() + '</span></li>');
                msg.html('');
                scrollTop = chat[0].scrollHeight;
                chat.parent().scrollTop(scrollTop);
            }
        });

        function a() {
            var si1 = document.getElementById('si_1');
            var si2 = document.getElementById('si_2');
            var si3 = document.getElementById('si_3');
            si1.onclick = function () {
                si1.style.background = "url(/static/images/icon/head_2_1.png) no-repeat";
                si2.style.background = "";
                si3.style.background = "";
            };
            si2.onclick = function () {
                si2.style.background = "url(/static/images/icon/head_3_1.png) no-repeat";
                si1.style.background = "";
                si3.style.background = "";
            };
            si3.onclick = function () {
                si3.style.background = "url(/static/images/icon/head_4_1.png) no-repeat";
                si1.style.background = "";
                si2.style.background = "";
            };
        };
        a();
        //图片放大
        $('#chatbox').on('click', '.send_msg', function () {
            j = 0;
            var this_ = $(this);
            images = $('#chatbox').find('.send_msg');
            var imagesArr = new Array();
            $.each(images, function (i, image) {
                j = j + 1;
                imagesArr.push($(image).attr('src'));
                $(image).attr('id', j);
            });
            $.pictureViewer({
                images: imagesArr, //需要查看的图片，数据类型为数组
                initImageIndex: this_.attr('id'), //初始查看第几张图片，默认0
                scrollSwitch: true //是否使用鼠标滚轮切换图片，默认false
            });
        });


    }
</script>
</body>
</html>
